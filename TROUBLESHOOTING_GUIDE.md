# 故障排查指南

## 版本：v3.6.1
**更新日期：** 2025年11月25日

---

## 🔍 如何诊断保存问题

### 症状：点击保存后无反应或提示错误

v3.6.1 版本已经大幅改进了错误提示机制。如果保存失败，程序会明确告诉您哪个字段有问题。

---

## 📋 常见错误及解决方法

### 错误 1：字段包含无效值 'None'

**错误信息示例：**
```
发现以下字段错误：

1. 【出生年月】
   错误：字段包含无效值 'None'，请清空或输入正确的出生年月（格式：YYYYMM）
   当前值：'None'
```

**原因：**
- 之前版本的bug导致数据库中某些字段存储了字符串 "None"
- 重新加载数据时，这些 "None" 字符串会显示在输入框中
- 保存时验证器检测到这是无效值

**解决方法：**
1. 找到错误提示中指出的字段
2. 如果该字段应该为空：直接删除输入框中的内容
3. 如果该字段应该有值：输入正确的值
4. 重新保存

**预防措施：**
- v3.6.1 版本已修复此问题
- 使用 `safe_str()` 函数确保加载时不会显示 "None"
- 旧数据需要手动清理一次

---

### 错误 2：日期格式错误

**错误信息示例：**
```
发现以下字段错误：

1. 【新辅助治疗日期】
   错误：格式错误，应为6位数字（YYMMDD），例如：250115
   当前值：'25-01-15'
```

**原因：**
- 输入的日期格式不正确
- 系统要求纯数字格式，不能包含横杠或斜杠

**解决方法：**
| 错误格式 | 正确格式 | 说明 |
|---------|---------|------|
| 25-01-15 | 250115 | 2025年1月15日 |
| 2025/01/15 | 250115 | 去掉斜杠 |
| 25115 | 250115 | 少了一个0 |

**日期格式规则：**
- **出生年月**：6位数字 `YYYYMM`（例如：199001 表示1990年1月）
- **治疗日期、手术日期等**：6位数字 `YYMMDD`（例如：250115 表示2025年1月15日）

---

### 错误 3：数字字段包含非数字内容

**错误信息示例：**
```
发现以下字段错误：

1. 【吸烟包年数】
   错误：应为数字，当前值：二十
   当前值：'二十'
```

**原因：**
- 数字字段中输入了中文或其他非数字字符

**解决方法：**
- 使用阿拉伯数字：`20`
- 可以包含小数点：`20.5`
- 不要输入中文数字或单位

---

### 错误 4：必填字段为空

**错误信息示例：**
```
发现以下字段错误：

1. 【住院号】
   错误：此字段为必填项

2. 【癌种】
   错误：此字段为必填项
```

**原因：**
- 必填字段没有填写

**必填字段列表：**
1. **住院号** - 患者唯一标识
2. **癌种** - 肺癌/食管癌
3. **性别** - 男/女

**解决方法：**
- 填写所有必填字段后再保存

---

## 🔧 使用日志文件诊断问题

### 日志文件位置

程序运行时会在当前目录生成 `app.log` 文件，包含详细的调试信息。

**文件位置：**
- Windows: 程序所在文件夹的 `app.log`
- 通常和 `thoracic.db` 在同一目录

### 如何查看日志

1. **打开日志文件：**
   ```
   使用记事本或任何文本编辑器打开 app.log
   ```

2. **查找最近的错误：**
   - 滚动到文件末尾
   - 查找包含 `[ERROR]` 的行
   - 查看错误发生的时间和详细信息

3. **示例日志内容：**
   ```
   2025-11-25 14:30:15 [DEBUG] 开始保存患者: hospital_id=H20250123
   2025-11-25 14:30:15 [DEBUG] 开始验证患者数据: hospital_id=H20250123
   2025-11-25 14:30:15 [ERROR] 患者数据验证失败:
   发现以下字段错误：
   
   1. 【出生年月】
      错误：字段包含无效值 'None'
      当前值：'None'
   ```

### 日志级别说明

- `[DEBUG]`: 调试信息（记录详细的执行步骤）
- `[INFO]`: 一般信息（记录重要操作）
- `[WARNING]`: 警告信息（可能的问题）
- `[ERROR]`: 错误信息（保存失败等）

---

## 🚑 紧急救援步骤

### 如果完全无法保存

**步骤 1：检查日志文件**
```
1. 找到 app.log 文件
2. 记录最后的错误信息
3. 截图保存
```

**步骤 2：尝试新建患者**
```
1. 点击"新建患者"按钮
2. 只填写必填字段（住院号、癌种、性别）
3. 尝试保存
4. 如果成功，说明是旧数据的问题
```

**步骤 3：手动清理数据**
```
1. 如果是现有患者无法保存
2. 记录所有字段内容
3. 删除该患者
4. 重新新建并录入
```

**步骤 4：联系支持**
```
如果以上步骤都失败，请联系开发者并提供：
1. app.log 文件内容（最后100行）
2. 操作系统版本
3. 出错的具体步骤
4. 截图
```

---

## 📊 诊断检查清单

保存失败时，按以下顺序检查：

- [ ] 检查错误提示对话框中列出的字段
- [ ] 确认所有必填字段已填写
- [ ] 检查日期字段格式（YYMMDD 或 YYYYMM）
- [ ] 检查数字字段是否包含非数字字符
- [ ] 检查是否有字段显示 "None" 字符串
- [ ] 查看 app.log 文件中的详细错误信息
- [ ] 尝试新建患者测试基本功能
- [ ] 检查数据库文件是否被占用或损坏

---

## 💡 预防措施

### 1. 定期备份数据库

```bash
# 手动备份
复制 thoracic.db 文件到安全位置
重命名为 thoracic_backup_20251125.db
```

### 2. 使用最新版本

- 确保使用 v3.6.1 或更高版本
- 旧版本可能存在已知的bug

### 3. 规范数据输入

- 日期统一使用数字格式
- 数字字段只输入数字
- 避免复制粘贴特殊格式的文本

### 4. 定期查看日志

- 每天检查一次 app.log
- 及时发现潜在问题
- 防止小问题积累成大问题

---

## 🔄 数据修复工具

### 清理 "None" 字符串的SQL脚本

如果发现大量数据包含 "None" 字符串，可以使用以下SQL批量清理：

```sql
-- 备份数据库
-- 然后在 SQLite 管理工具中执行

UPDATE Patient SET birth_ym4 = NULL WHERE birth_ym4 = 'None';
UPDATE Patient SET pack_years = NULL WHERE pack_years = 'None';
UPDATE Patient SET nac_date = NULL WHERE nac_date = 'None';
UPDATE Patient SET adj_date = NULL WHERE adj_date = 'None';

-- 对其他表重复相同操作
UPDATE Surgery SET surgery_date6 = NULL WHERE surgery_date6 = 'None';
UPDATE Pathology SET pathology_date = NULL WHERE pathology_date = 'None';
-- ... 根据需要添加更多字段
```

**警告：** 执行SQL前请务必备份数据库！

---

## 📞 获取帮助

### 反馈渠道

1. **GitHub Issues**
   - https://github.com/xenorexq/Thoracic-Database/issues
   - 适合bug报告和功能请求

2. **邮件支持**
   - qinzhi100@gmail.com
   - 附上 app.log 文件

### 反馈时请提供

1. ✅ 程序版本号（v3.6.1）
2. ✅ 操作系统版本
3. ✅ app.log 文件内容（最后100行）
4. ✅ 详细的操作步骤
5. ✅ 截图（如有）
6. ✅ 能否稳定复现

---

## 🎯 快速参考

### 常用日期格式

| 字段 | 格式 | 示例 | 说明 |
|-----|------|-----|------|
| 出生年月 | YYYYMM | 199001 | 1990年1月 |
| 手术日期 | YYMMDD | 250115 | 2025年1月15日 |
| 治疗日期 | YYMMDD | 241220 | 2024年12月20日 |

### 文件位置

| 文件 | 说明 | 位置 |
|-----|------|-----|
| thoracic.db | 数据库文件 | 程序目录 |
| app.log | 日志文件 | 程序目录 |
| thoracic_entry.exe | 可执行文件 | dist目录 |

---

**最后更新：** 2025年11月25日  
**适用版本：** v3.6.1 及以上

如有问题，请随时联系我们！


