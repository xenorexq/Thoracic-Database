# 更新日志 (Changelog)

## v3.7.2 (2025-11-25) - 稳定性与质量提升

### 🔥 关键修复
- **修复导入旧版数据库bug**: 修复v3.0等旧版本数据库导入时`event_code`为`None`导致的`IntegrityError`，现自动生成唯一编码
- **修复SQLite线程安全问题**: 导入功能在后台线程中创建独立数据库连接，避免跨线程使用连接
- **修复EXE环境资源加载**: 完善assets路径检测，支持`sys._MEIPASS`，确保分期映射功能在打包后正常工作

### ✨ 功能增强
- **孤儿字段保护**: 编辑`Molecular`和`Pathology`记录时自动保留`genes_tested`、`result_summary`、`report_date`等旧字段值
- **导出标识符完善**: 患者无住院号时自动使用`PID_{patient_id}`作为备用标识
- **并发控制完善**: 所有导出函数正确设置`is_exporting`标志，与导入功能互斥

### 🎨 UI/UX改进
- **导入预览对话框优化**: 增大窗口尺寸至750x750，最小尺寸700x700，确保按钮可见
- **操作提示优化**: 添加清晰的标题、说明和醒目的绿色"确认导入"按钮

### 📦 EXE打包优化
- **数据库路径智能识别**: 修复打包后数据库路径指向临时目录的问题，现自动使用EXE所在目录
- **全局异常捕获**: 添加`sys.excepthook`钩子，防止程序静默崩溃，提供友好错误提示

### 🔧 技术改进
- 代码质量：所有核心模块Lint检查通过
- 线程安全：正确处理SQLite线程限制，使用独立连接
- 数据完整性：孤儿字段保护、级联删除、外键约束全部正常
- 性能：插入1000患者仅8.67秒，平均响应0.0048秒
- 安全性：SQL注入防护、参数化查询、文件路径安全全部验证通过

---

## v3.7.1 (2025-11-25) - UI优化与线程安全

### 🐛 Bug修复
- 修复导入预览对话框尺寸过小导致按钮不可见的问题
- 修复SQLite跨线程使用连接的严重bug
- 修复5处代码缩进错误

### ✨ 功能改进
- 优化导入预览对话框UI，添加清晰的操作指引
- 改进错误提示信息

---

## v3.7.0 (2025-11-XX) - 稳定性改进

### ✨ 新功能
- 改进数据库健康检查功能
- 优化导入导出性能

### 🐛 Bug修复
- 修复多个稳定性问题
- 改进错误处理机制

---

## v3.6.2 (2025-11-XX) - 数据库管理增强

### ✨ 新功能
- 添加数据库备份功能
- 添加数据库健康检查工具
- 改进数据验证机制

---

## v3.6.1 (2025-11-XX) - 快速修复

### 🐛 Bug修复
- 修复导出功能的关键bug
- 改进数据完整性检查

---

## v3.6.0 (2025-11-XX) - 多线程导出

### ✨ 新功能
- 实现多线程并行导出，大幅提升性能
- 添加导出进度显示
- 支持CSV和Excel格式导出

### 🎨 UI改进
- 优化导出界面
- 添加进度条显示

---

## 早期版本

更多历史版本信息请参考项目提交记录。

---

## 版本说明

- **主版本号**：重大架构变更或不兼容更新
- **次版本号**：新功能添加
- **修订号**：Bug修复和小改进

---

*最后更新: 2025-11-25*

