# 版本更新日志 - v3.6.1

**发布日期：** 2025年11月25日
**类型：** Bug修复和功能增强

---

## 🐛 严重Bug修复

### 1. 修复打包后无法保存患者信息的问题

**问题描述：**
- 在打包为 `.exe` 文件后，用户输入患者信息后点击保存，数据无法保存到数据库
- 问题仅在打包环境出现，开发环境正常

**根本原因：**
- `ui/patient_tab.py` 中第733-736行使用 `sqlite3.Row.get()` 方法
- 在某些打包环境中，`sqlite3.Row` 对象的 `.get()` 方法不可用或行为异常
- 导致无法正确获取现有患者的 `patient_id`，进而保存失败

**解决方案：**
```python
# 修复前（有问题）
existing = self.db.get_patient_by_hospital_id(hospital_id)
if existing:
    pid = existing.get("patient_id") or existing.get("id")

# 修复后（使用dict转换）
existing = self.db.get_patient_by_hospital_id(hospital_id)
if existing:
    try:
        existing_dict = dict(existing)
        pid = existing_dict.get("patient_id")
    except Exception as conv_err:
        # 备用方案：使用索引访问
        pid = existing["patient_id"]
```

**修复内容：**
- ✅ 将 `sqlite3.Row` 转换为普通字典，确保跨环境兼容性
- ✅ 添加异常处理和备用方案（索引访问）
- ✅ 添加详细的调试日志
- ✅ 移除错误的 `.get("id")` 备用查询（Patient表主键是`patient_id`而不是`id`）

---

## 🎯 功能增强

### 2. 导入功能预检查机制

**新功能：**
- 选择要导入的数据库文件后，系统先进行预检查分析
- 生成详细的导入预览报告
- 用户确认后才执行实际导入

**预检查内容：**
1. **源文件分析**
   - 统计每个文件的患者数量
   - 检测文件间的重复患者
   
2. **重复检测**
   - 检测与本地数据库的重复（按 `hospital_id`）
   - 检测源文件之间的重复
   
3. **关联数据预估**
   - 预估将导入的手术记录数
   - 预估将导入的病理记录数
   - 预估将导入的分子检测记录数
   - 预估将导入的随访事件数

**预览对话框功能：**
- ✅ 显示导入摘要统计
- ✅ 详细列出重复患者信息
- ✅ 可导出预检查报告为文本文件
- ✅ 用户可选择确认或取消导入

**新增文件：**
- `db/import_checker.py` - 预检查逻辑
- `ui/import_preview_dialog.py` - 预览对话框

**示例报告：**
```
============================================================
数据库导入预检查报告
============================================================

源文件数量: 2 个
  1. database1.db
  2. database2.db

患者数据分析:
  • 源文件总患者数: 150 位
  • 可导入的新患者: 120 位
  • 与本地库重复: 25 位
  • 源文件间重复: 5 对

预计导入的关联数据:
  • 手术记录: 约 110 条
  • 病理记录: 约 105 条
  • 分子记录: 约 80 条
  • 随访事件: 约 250 条

与本地库重复的患者（将跳过）:
  1. H20250001 (肺癌) - 来自 database1.db
  2. H20250002 (食管癌) - 来自 database1.db
  ...

============================================================
✓ 可以导入 120 位新患者及其关联数据
============================================================
```

### 3. 增强的日志系统

**新功能：**
- 添加专门的应用程序日志模块 `utils/logger.py`
- 所有关键操作记录到 `app.log` 文件
- 打包后的 exe 也能生成日志文件

**日志级别：**
- `DEBUG`: 详细的调试信息
- `INFO`: 重要操作信息
- `WARNING`: 警告信息
- `ERROR`: 错误信息（包含堆栈跟踪）

**日志位置：**
- 文件：程序运行目录下的 `app.log`
- 控制台：实时输出（INFO 及以上级别）

**关键操作日志：**
- ✅ 患者信息保存过程
- ✅ 数据库查询操作
- ✅ 异常和错误详情
- ✅ 应用启动信息

**示例日志：**
```
2025-11-25 10:30:15 [INFO] thoracic_app - 应用程序启动
2025-11-25 10:30:15 [INFO] thoracic_app - Python 版本: 3.10.11
2025-11-25 10:30:20 [DEBUG] thoracic_app - 开始保存患者: hospital_id=H20250123
2025-11-25 10:30:20 [DEBUG] thoracic_app - 查询已存在的患者: H20250123
2025-11-25 10:30:20 [DEBUG] thoracic_app - 未找到现有患者，将创建新患者
2025-11-25 10:30:20 [INFO] thoracic_app - 患者已创建: ID=456
```

---

## 📝 修改的文件

### 核心修复
1. **ui/patient_tab.py**
   - 修复 `sqlite3.Row` 兼容性问题
   - 添加详细的调试日志
   - 改进错误处理机制

### 新增功能
2. **db/import_checker.py** (新建)
   - 导入预检查核心逻辑
   - 重复检测算法
   - 关联数据预估

3. **ui/import_preview_dialog.py** (新建)
   - 预览对话框 UI
   - 报告导出功能
   - 用户确认交互

4. **utils/logger.py** (新建)
   - 统一的日志管理
   - 文件和控制台双输出
   - 异常堆栈跟踪

5. **main.py**
   - 集成导入预检查功能
   - 添加进度条方法（之前遗漏的）
   - 更新版本号到 v3.6.1

---

## 🔧 技术改进

### 1. 跨环境兼容性
- 不再依赖 `sqlite3.Row.get()` 方法
- 统一使用 `dict()` 转换确保兼容性
- 添加多级备用方案

### 2. 错误诊断能力
- 详细的日志记录
- 完整的堆栈跟踪
- 用户友好的错误提示

### 3. 导入安全性
- 预检查机制避免盲目导入
- 详细的重复检测
- 用户确认机制

---

## 📊 测试结果

### 打包测试
- ✅ Windows 10/11 (PyInstaller)
- ✅ 患者信息保存/更新
- ✅ 多个数据库导入
- ✅ 日志文件生成

### 功能测试
- ✅ 新建患者
- ✅ 更新现有患者
- ✅ 重复检测
- ✅ 导入预览
- ✅ 错误处理

---

## 🚀 升级指南

### 从 v3.6.0 升级

1. **备份数据**（推荐）：
   ```bash
   cp thoracic.db thoracic.db.backup
   ```

2. **更新程序文件**：
   - 替换所有 `.py` 文件
   - 保留现有数据库文件

3. **重新打包**（如需要）：
   ```bash
   python build_exe_ultimate.bat
   ```

4. **测试功能**：
   - 新建一个测试患者
   - 保存并验证
   - 检查 `app.log` 文件是否生成

### 兼容性
- ✅ 完全兼容 v3.6.0 数据库
- ✅ 无需数据迁移
- ✅ 配置文件无变化

---

## 📋 使用建议

### 1. 遇到保存问题时
1. 检查程序运行目录下的 `app.log` 文件
2. 查看最后的错误信息
3. 将 `app.log` 内容反馈给开发者

### 2. 导入数据库时
1. 使用新的预检查功能
2. 仔细阅读导入预览报告
3. 确认无误后再执行导入
4. 必要时导出预览报告备查

### 3. 打包分发时
- 确保使用最新版本打包
- 测试打包后的 exe 文件
- 向用户说明 `app.log` 的作用

---

## 🙏 致谢

感谢临床助理们的反馈和测试！特别感谢报告打包后无法保存的问题。

---

## 📞 问题反馈

如遇到问题，请提供：
1. `app.log` 文件内容
2. 操作系统版本
3. 操作步骤描述
4. 截图（如有）

反馈渠道：
- **GitHub Issues**: https://github.com/xenorexq/Thoracic-Database/issues
- **邮箱**: qinzhi100@gmail.com

---

**版本**: v3.6.1  
**更新日期**: 2025年11月25日  
**优先级**: 🔴 高（严重Bug修复）  
**建议**: 建议所有用户立即更新

