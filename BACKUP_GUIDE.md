# 数据库备份功能使用指南

## 版本：v3.6.1+
**新增日期：** 2025年11月25日

---

## 🎯 功能概述

数据库备份功能可以帮助您快速创建当前数据库的副本，防止数据丢失。

---

## 📋 使用方法

### 方式一：通过菜单（推荐）

1. **打开备份功能**
   ```
   菜单栏 → 文件 → 备份数据库...
   ```

2. **选择保存位置**
   - 系统会自动生成默认文件名
   - 格式：`thoracic_backup_YYYYMMDD.db`
   - 例如：`thoracic_backup_20251125.db`

3. **确认备份**
   - 点击"保存"按钮
   - 等待备份完成

4. **查看结果**
   ```
   ✓ 数据库已成功备份到：
   
   C:\Users\用户名\Documents\thoracic_backup_20251125.db
   
   文件大小：15.32 MB
   备份时间：2025-11-25 14:30:45
   ```

### 方式二：手动复制

如果程序无法运行，也可以手动备份：

1. 找到数据库文件 `thoracic.db`
2. 复制该文件
3. 粘贴到安全位置
4. 重命名为 `thoracic_backup_20251125.db`

---

## 🔒 备份策略建议

### 每日备份（推荐）

```
在每天工作结束前执行一次备份
文件名示例：
  - thoracic_backup_20251125.db (周一)
  - thoracic_backup_20251126.db (周二)
  - thoracic_backup_20251127.db (周三)
  ...
```

**优点：**
- 可以恢复到任意一天的状态
- 防止误操作导致的数据丢失

### 重要操作前备份

**建议在以下操作前备份：**

1. **批量导入数据**
   ```
   导入前 → 备份 → 导入 → 验证
   ```

2. **大量删除操作**
   ```
   删除前 → 备份 → 删除 → 确认
   ```

3. **程序升级**
   ```
   升级前 → 备份 → 升级 → 测试
   ```

4. **数据修复**
   ```
   修复前 → 备份 → 修复 → 验证
   ```

### 定期归档

**建议每月创建一次归档备份：**

```
每月1号：
  - 创建归档：thoracic_archive_202511.db
  - 移动到专门的归档文件夹
  - 保留至少6个月
```

---

## 📁 备份文件管理

### 推荐的文件夹结构

```
我的文档/
└── 胸外科数据库备份/
    ├── 每日备份/
    │   ├── thoracic_backup_20251120.db
    │   ├── thoracic_backup_20251121.db
    │   ├── thoracic_backup_20251122.db
    │   ├── thoracic_backup_20251123.db
    │   ├── thoracic_backup_20251124.db
    │   └── thoracic_backup_20251125.db (最新)
    │
    ├── 月度归档/
    │   ├── thoracic_archive_202509.db
    │   ├── thoracic_archive_202510.db
    │   └── thoracic_archive_202511.db
    │
    └── 重要节点/
        ├── thoracic_before_upgrade_v360.db
        ├── thoracic_before_import_20251120.db
        └── thoracic_milestone_1000patients.db
```

### 文件命名规范

| 类型 | 命名格式 | 示例 |
|-----|---------|------|
| 每日备份 | thoracic_backup_YYYYMMDD.db | thoracic_backup_20251125.db |
| 月度归档 | thoracic_archive_YYYYMM.db | thoracic_archive_202511.db |
| 升级前备份 | thoracic_before_upgrade_vXXX.db | thoracic_before_upgrade_v360.db |
| 里程碑备份 | thoracic_milestone_XXX.db | thoracic_milestone_1000patients.db |

---

## ⚠️ 注意事项

### 1. 备份时机

**不要在以下情况备份：**
- ❌ 程序正在导入数据
- ❌ 程序正在执行大量写入操作
- ❌ 程序正在导出数据

**最佳备份时机：**
- ✅ 所有窗口都已关闭
- ✅ 没有正在进行的操作
- ✅ 数据已全部保存

### 2. 存储位置

**建议的存储位置：**
- ✅ 本地硬盘的非系统分区（如 D:\备份）
- ✅ 外部U盘或移动硬盘
- ✅ 网络驱动器（如果速度足够快）
- ✅ 云存储（OneDrive, Google Drive等）

**不建议的存储位置：**
- ❌ 与程序同一目录（没有隔离性）
- ❌ 系统盘C盘根目录（系统崩溃会一起丢失）
- ❌ 临时文件夹（可能被自动清理）

### 3. 备份验证

**定期验证备份文件的完整性：**

1. **检查文件大小**
   ```
   备份文件应该和原文件大小相同
   明显偏小说明备份不完整
   ```

2. **尝试打开备份**
   ```
   每月随机选择一个备份文件
   使用程序尝试打开
   验证数据是否完整
   ```

3. **检查文件日期**
   ```
   确认文件修改日期正确
   防止备份了旧文件
   ```

---

## 🔄 如何恢复备份

### 场景一：程序可以运行

1. **关闭当前程序**

2. **替换数据库文件**
   ```
   将 thoracic_backup_20251125.db
   重命名为 thoracic.db
   复制到程序目录
   ```

3. **重新打开程序**
   - 验证数据是否正确
   - 检查患者数量是否匹配

### 场景二：程序无法运行

1. **重新安装程序**
   - 下载最新版本
   - 安装到新位置

2. **复制备份文件**
   ```
   将备份文件复制到新安装目录
   重命名为 thoracic.db
   ```

3. **启动程序**
   - 程序会自动识别数据库
   - 验证数据完整性

### 场景三：需要恢复到特定日期

1. **查找对应日期的备份**
   ```
   例如：要恢复到11月20日
   找到：thoracic_backup_20251120.db
   ```

2. **执行恢复**
   ```
   关闭程序 → 替换文件 → 重新打开
   ```

3. **验证数据**
   - 检查患者列表
   - 确认数据准确性
   - 必要时重新录入最近的数据

---

## 📊 备份空间需求

### 单个备份文件大小估算

| 患者数量 | 估计大小 | 说明 |
|---------|---------|-----|
| 100 | 5-10 MB | 包含所有关联数据 |
| 500 | 20-30 MB | 中等规模数据库 |
| 1000 | 40-60 MB | 大型数据库 |
| 5000 | 200-300 MB | 超大规模数据库 |

### 存储空间规划

**每日备份（保留7天）：**
```
单文件 50 MB × 7 天 = 350 MB
```

**月度归档（保留6个月）：**
```
单文件 50 MB × 6 月 = 300 MB
```

**总需求：**
```
350 MB + 300 MB = 650 MB
建议预留 1 GB 空间
```

---

## 🚨 紧急恢复流程

### 如果误删了患者或数据

1. **立即停止操作**
   ```
   不要继续输入或保存
   立即关闭程序
   ```

2. **使用最近的备份**
   ```
   找到最近一次备份文件
   替换当前数据库
   ```

3. **评估损失**
   ```
   对比备份时间和当前时间
   确定丢失了哪些数据
   ```

4. **补录数据**
   ```
   根据记录补充丢失的数据
   完成后立即创建新备份
   ```

### 如果所有备份都损坏

1. **尝试数据库修复**
   ```
   使用 SQLite 数据库修复工具
   尝试恢复部分数据
   ```

2. **联系技术支持**
   ```
   发送损坏的数据库文件
   寻求专业帮助
   ```

3. **从原始记录重建**
   ```
   如果无法恢复
   只能从纸质或电子病历重新录入
   ```

---

## 💡 自动化备份脚本

### Windows 批处理脚本

创建 `auto_backup.bat` 文件：

```batch
@echo off
REM 自动备份胸外科数据库

REM 设置路径
set SOURCE=C:\Program Files\ThoracicDB\thoracic.db
set BACKUP_DIR=D:\Backup\ThoracicDB

REM 生成日期文件名
for /f "tokens=1-3 delims=/ " %%a in ('date /t') do set DATE=%%c%%a%%b
set BACKUP_FILE=thoracic_backup_%DATE%.db

REM 创建备份目录
if not exist "%BACKUP_DIR%" mkdir "%BACKUP_DIR%"

REM 执行备份
copy "%SOURCE%" "%BACKUP_DIR%\%BACKUP_FILE%"

REM 显示结果
if %errorlevel% equ 0 (
    echo 备份成功：%BACKUP_FILE%
) else (
    echo 备份失败！
)

pause
```

### 设置计划任务

1. 打开"任务计划程序"
2. 创建基本任务
3. 触发器：每天下午6点
4. 操作：启动程序 → `auto_backup.bat`
5. 确定并测试

---

## 📞 相关资源

- **数据恢复工具**: SQLite Database Browser
- **技术支持**: qinzhi100@gmail.com
- **GitHub**: https://github.com/xenorexq/Thoracic-Database

---

## 🎯 快速检查清单

备份前检查：
- [ ] 所有数据已保存
- [ ] 没有正在进行的操作
- [ ] 选择了正确的保存位置
- [ ] 文件名包含日期信息

备份后检查：
- [ ] 备份文件大小正常
- [ ] 文件名正确
- [ ] 保存位置正确
- [ ] 记录备份时间

定期检查：
- [ ] 每周清理过期的每日备份
- [ ] 每月创建归档备份
- [ ] 每季度验证备份可用性
- [ ] 每年整理存储空间

---

**建议：** 备份是保护数据的最后一道防线，请务必养成定期备份的习惯！

**版本：** v3.6.1+  
**更新日期：** 2025年11月25日


