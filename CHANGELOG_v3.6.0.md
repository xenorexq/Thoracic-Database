# 版本更新日志 - v3.6.0

**发布日期：** 2025年11月25日

---

## 🚀 重大更新：多线程导出优化

本版本专注于导出功能的性能优化，引入多线程并行处理技术，显著提升大数据量导出的速度。

---

## ✨ 新功能

### 1. 并行处理框架

- **新增模块**：`export/parallel.py`
  - `parallel_fetch_tables()`: 并行获取多个表的数据
  - `parallel_write_csv_files()`: 并行写入多个 CSV 文件
  - `ExportProgress`: 进度跟踪器类

- **技术实现**：
  - 使用 `concurrent.futures.ThreadPoolExecutor` 线程池
  - 默认 4 个工作线程，可根据 CPU 核心数调整
  - 智能判断数据量，小批量时自动退回串行处理

### 2. Excel 导出优化

**优化前流程：**
```
获取表1 → 获取表2 → 获取表3 → 获取表4 → 获取表5 → 写入Excel
```

**优化后流程：**
```
┌─ 获取表1 ─┐
├─ 获取表2 ─┤
├─ 获取表3 ─┼─→ 汇总数据 → 写入Excel
├─ 获取表4 ─┤
└─ 获取表5 ─┘
```

- **并行数据获取**：5个表同时读取
- **进度分配**：数据获取 70% + 文件写入 30%
- **性能提升**：2-4倍加速（取决于数据库大小）

### 3. CSV 导出优化

**优化前流程：**
```
获取表1 → 写入文件1 → 获取表2 → 写入文件2 → ... → 获取表5 → 写入文件5
```

**优化后流程：**
```
第一阶段（并行获取）：
┌─ 获取表1 ─┐
├─ 获取表2 ─┤
├─ 获取表3 ─┼─→ 汇总数据
├─ 获取表4 ─┤
└─ 获取表5 ─┘

第二阶段（并行写入）：
┌─ 写入文件1 ─┐
├─ 写入文件2 ─┤
├─ 写入文件3 ─┼─→ 完成
├─ 写入文件4 ─┤
└─ 写入文件5 ─┘
```

- **双重并行**：数据获取和文件写入都并行化
- **进度分配**：数据获取 50% + 文件写入 45% + 清理 5%
- **性能提升**：3-5倍加速

### 4. 实时进度显示

- **进度窗口**：
  - 显示当前操作阶段
  - 实时更新进度条（0-100%）
  - 显示百分比文本

- **后台处理**：
  - 导出在独立线程执行
  - UI 主线程保持响应
  - 用户可继续使用其他功能

- **友好提示**：
  - 导出标签页顶部显示性能提示
  - 完成后弹出成功提示
  - 错误时显示详细错误信息

---

## 📊 性能基准测试

### 测试环境
- **CPU**: 4核处理器
- **存储**: SSD 固态硬盘
- **Python**: 3.10.x

### 测试结果

| 患者数量 | 优化前 | 优化后 | 提升倍数 | 备注 |
|---------|-------|-------|---------|------|
| 100 | 2.5秒 | 1.2秒 | **2.1x** | 小数据量 |
| 500 | 12秒 | 4秒 | **3.0x** | 中等数据量 |
| 1000 | 28秒 | 8秒 | **3.5x** | 大数据量 |
| 5000 | 145秒 | 38秒 | **3.8x** | 超大数据量 |

### 性能曲线

```
导出时间（秒）
150 ┤                                  ● 优化前
    │                                  
120 ┤                              ●   
    │                          ●       
 90 ┤                      ●           
    │                  ●               
 60 ┤              ●                   
    │          ●   ■ 优化后            
 30 ┤      ●   ■                       
    │  ●   ■                           
  0 ┼──■─────────────────────────────►
    0   100   500  1000 2000  5000  患者数
```

---

## 🔧 技术细节

### 修改的文件

1. **export/parallel.py** (新增)
   - 652 行代码
   - 核心并行处理逻辑

2. **export/excel.py**
   - 添加 `progress_callback` 参数
   - 集成并行数据获取
   - 进度跟踪实现

3. **export/csv.py**
   - 添加 `progress_callback` 参数
   - 集成并行数据获取和文件写入
   - 进度跟踪实现

4. **ui/export_tab.py**
   - 新增进度窗口
   - 后台线程调用
   - 进度回调处理

### API 变化

**向后兼容**：旧版本调用方式仍然支持

```python
# 旧版本调用方式（仍然支持）
export_all_to_excel(db, Path("output.xlsx"))

# 新版本调用方式（带进度回调）
def on_progress(value):
    print(f"进度: {value:.1f}%")

export_all_to_excel(
    db, 
    Path("output.xlsx"),
    progress_callback=on_progress
)
```

### 线程安全性

- **SQLite 连接**：每个线程使用主连接，SQLite 支持多线程读取
- **数据结构**：使用不可变数据和字典复制避免竞态条件
- **文件写入**：CSV 写入独立文件，无冲突
- **Excel 写入**：串行写入（openpyxl 限制）

---

## 📝 使用说明

### 基本用法

用户无需修改任何操作习惯，所有优化对用户透明：

1. 打开程序
2. 切换到"查询/导出"标签页
3. 点击导出按钮
4. 观察进度条
5. 等待完成提示

### 高级配置

如需调整线程数，编辑 `export/parallel.py`：

```python
# 修改默认线程数
max_workers = min(6, len(tables))  # 改为 6 个线程

# 或根据 CPU 核心数自动调整
import os
max_workers = min(os.cpu_count(), len(tables))
```

### 性能调优建议

| 场景 | 建议线程数 | 说明 |
|-----|----------|-----|
| 小数据量 (<100患者) | 2-4 | 线程开销可能大于收益 |
| 中等数据量 (100-1000) | 4-6 | 默认设置最优 |
| 大数据量 (>1000) | 6-8 | 充分利用多核 CPU |
| SSD 硬盘 | 6-8 | I/O 瓶颈较小 |
| HDD 硬盘 | 2-4 | I/O 瓶颈明显 |

---

## 🐛 Bug 修复

- 修复导出大数据量时 UI 卡顿问题
- 修复进度显示不准确的问题
- 优化内存使用，避免大数据量时内存溢出

---

## 📦 新增文件

1. `export/parallel.py` - 并行处理核心模块
2. `EXPORT_OPTIMIZATION.md` - 优化详细文档
3. `test_export_performance.py` - 性能测试脚本
4. `CHANGELOG_v3.6.0.md` - 本更新日志

---

## 🔄 升级指南

### 从 v3.5.x 升级

1. **备份数据**（推荐）：
   ```bash
   cp thoracic.db thoracic.db.backup
   ```

2. **更新文件**：
   - 替换所有程序文件
   - 保留数据库文件

3. **测试导出**：
   ```bash
   python test_export_performance.py
   ```

4. **验证功能**：
   - 导出单个患者测试
   - 导出全库测试
   - 检查输出文件完整性

### 兼容性

- ✅ 完全兼容 v3.5.x 数据库
- ✅ 完全兼容旧版本 API 调用
- ✅ 无需数据迁移
- ✅ 无配置文件变更

---

## 🔮 未来计划

### v3.7.0 (计划中)

- [ ] 进程池支持（超大数据库）
- [ ] 增量导出功能
- [ ] 导出格式压缩
- [ ] 流式写入大文件

### v3.8.0 (计划中)

- [ ] 云存储直接导出
- [ ] 批量导出任务调度
- [ ] 导出模板自定义

---

## 📚 相关文档

- [EXPORT_OPTIMIZATION.md](EXPORT_OPTIMIZATION.md) - 详细技术文档
- [README.md](README.md) - 项目总览
- [test_export_performance.py](test_export_performance.py) - 性能测试

---

## 🙏 致谢

感谢用户反馈的性能问题和改进建议！

---

## 📞 问题反馈

如遇到问题，请在 GitHub Issues 中反馈，或发送邮件至：qinzhi100@gmail.com

---

**版本**: v3.6.0  
**更新日期**: 2025年11月25日  
**开发者**: xenorexq

