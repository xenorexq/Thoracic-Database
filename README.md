# 胸外科科研数据录入系统 (v1.26)

本项目是一个基于 Python/Tkinter 的桌面应用程序，旨在在脱机环境中帮助胸外科科研人员录入、管理和导出肺癌/食管癌患者的临床数据。应用使用本地 SQLite 数据库 `thoracic.db` 存储数据，无需任何服务器或网络依赖，支持通过 PyInstaller 打包为单文件可执行程序在 Windows 上运行。

## 功能概述

* 患者信息录入：住院号唯一、癌种（肺癌/食管癌）、性别、出生年月、吸烟史、TNM 分期、食管前置因素、新辅助/术后治疗等。
* 手术记录：可为同一患者录入多次手术，支持肺癌与食管癌不同模板。自动计算手术时长并支持跨日。
* 病理记录：多条/人，包括标本类型、组织学、pTNM、分期、淋巴结信息、TRG 等。
* 分子检测记录：多条/人，支持 PCR/NGS 平台、基因、突变、PD‑L1、TMB/MSI、检测日期等。
* 随访记录：每人 0–1 条，记录最近随访日期、生存状态、复发信息、OS/DFS 等。
* 快速查找：通过住院号或患者 ID 精确定位患者并加载其所有关联记录。
* 自动分期：如果在 `assets/` 目录下提供 AJCC v9 分期映射 CSV，则根据 TNM 和前置条件即时显示分期结果。
* 导出功能：支持导出当前患者或整个数据库为 Excel (`.xlsx`) 或 CSV 多文件，字段完整、含列名。
* 键盘快捷键：Ctrl+S 保存、Ctrl+N 新建、Delete 删除当前记录。

## 项目结构

```
thoracic_entry/
├── assets/            # 图标和可选的 AJCC 分期映射 CSV（map_lung_v9.csv 等）
├── db/
│   └── models.py      # SQLite 数据库定义及数据访问对象
├── export/
│   ├── excel.py       # Excel 导出实现（依赖 openpyxl）
│   └── csv.py         # CSV 导出实现
├── staging/
│   └── lookup.py      # 分期映射加载及查询函数
├── ui/
│   ├── patient_tab.py # 患者/治疗 Tab
│   ├── surgery_tab.py # 手术 Tab
│   ├── path_tab.py    # 病理 Tab
│   ├── mol_tab.py     # 分子 Tab
│   ├── fu_tab.py      # 随访 Tab
│   └── export_tab.py  # 查询/导出 Tab
├── utils/
│   └── validators.py  # 输入校验和格式化函数
├── main.py            # 应用入口
├── requirements.txt   # 依赖列表（openpyxl）
└── README.md          # 使用说明
```

## 安装与运行

1. 确保安装 Python 3.10+ 环境。若需打包请安装 `pyinstaller`：

   ```bash
   pip install -r requirements.txt
   pip install pyinstaller
   ```

2. （可选）将 AJCC v9 分期映射 CSV 放入 `assets/` 目录下，文件名需为 `map_lung_v9.csv`、`map_eso_v9_scc.csv`、`map_eso_v9_ad.csv`。首次启动程序会自动读取并填充映射表。

3. 运行应用：

   ```bash
   python -m thoracic_entry.main
   ```

   首次运行时会在当前目录下生成 `thoracic.db` 数据库文件并自动建表。

4. 打包 Windows 可执行文件：

   ```bash
   pyinstaller --noconfirm --clean --onefile --name thoracic_entry --icon=assets/app.ico thoracic_entry/main.py
   ```

   打包完成后，在 `dist/` 目录下生成 `thoracic_entry.exe`。该可执行文件可在无 Python 环境的 Windows 系统上直接运行，不需要管理员权限。

## 使用说明

1. **新建患者**：在“患者/治疗”页填写住院号、癌种、性别等必填项（带 * 号）。填完点击“保存”或按 `Ctrl+S` 保存。住院号必须唯一，重复会提示错误。
2. **录入手术/病理/分子/随访**：保存患者后切换到相应 Tab 进行录入。列表中显示已有记录，点击可编辑；点击“新建”清空表单；点击“删除”移除当前记录。
3. **快速查找**：在窗口顶部输入住院号或患者 ID 后点击“查找”，程序会加载对应患者及其所有关联记录。
4. **导出**：在“查询/导出”页可以导出当前患者或全库数据。选择导出为 Excel 时需指定 `.xlsx` 文件保存路径；导出为 CSV 时需选择输出目录，程序会生成多个 CSV 文件。
5. **自动分期**：若提供了分期映射表，选择 TNM 及食管前置后分期文本会自动刷新。若映射表为空或找不到匹配项，分期处留空。
6. **数据校验**：
   * 出生年月（yymm）、手术日期（yymmdd）、报告/检测日期等必须为纯数字并符合格式要求。
   * 时间（hhmm）必须 0000–2359，分钟小于 60；程序会自动计算跨日时长。
   * 必填项未填或格式错误将阻止保存并提示错误信息。

## 常见问题与排查

* **无法启动或提示缺少模块**：请确认已安装依赖 `openpyxl` 和 `pyinstaller`，并使用正确版本的 Python。
* **无法写入数据库或导出文件**：检查程序所在目录或目标目录是否具有写权限，避免路径包含中文或特殊字符。
* **杀毒软件误报**：由于本程序使用 PyInstaller 打包，部分杀毒软件可能误报。请添加信任或排除。

## 示例测试数据

运行程序后可按以下步骤测试基本功能：

1. 在患者页点击“新建”，输入：
   * 住院号：`H123456`
   * 癌种：`肺癌`
   * 性别：`男`
   * 出生年月：`9007`
   * 吸烟包·年：`20.5`
   * 多源发星标：勾选
   * 肺 TNM：`T1b`, `N0`, `M0`
   点击保存。
2. 切换到手术页，点击“新建”，输入：
   * 手术日期：`241015`
   * 开始：`0830`
   * 结束：`1115`
   * 其他字段可留默认，点击保存。检查时长显示为 `165` 分钟。
3. 再次新建，测试跨日手术：开始 `2305`，结束 `0040`，保存后时长为 `95` 分钟。
4. 切换到随访页输入随访日期、状态等，保存。
5. 在导出页导出当前患者为 Excel 和 CSV，检查生成文件内容完整。

## 更新历史
### v1.12（2025-10-20）

* **手术方式顺序调整**：在手术标签页的肺癌手术细节中，手术方式下拉框将“胸腔镜”移动到第一位，以便更方便选择。
* **修复病理记录保存问题**：修正了病理标签页保存功能无响应的错误，主要原因是当TRG下拉框选择“N/A”时错误地尝试解析数字。现在选择“N/A”或空值时不会再抛出异常，保存功能可正常工作。
* **改进数据库行处理**：加载病理或分子列表时，统一将SQLite查询结果转换为字典，避免调用 `.get` 导致的 `sqlite3.Row` 错误。

### v1.13（2025-10-20）

* **分子列表新增平台列**：在分子标签页的列表中，`mol_id` 列后增加 `platform` 列，用于显示每条分子记录的检测平台。
* **病理列表列调整**：在病理标签页的列表中，删除原来的 `分期` 列，改为显示 `标本类型` 列，以便更直观地查看样本来源。

### v1.14（2025-10-20）

* **精简导出字段**：导出的 CSV 和 Excel 文件将不再包含已废弃的字段（如 `vendor_lab`、`ln_total`、`ln_positive` 等），以避免冗余信息。所有用户填写的有效字段都会完整导出，保证输入与输出一致。

### v1.15（2025-10-20）

* **导出数据使用住院号识别患者**：所有导出的表格现以 `hospital_id` 作为唯一标识，不再导出内部 `patient_id`。对于手术、病理、分子和随访表，每行都会新增 `hospital_id` 列，而 `patient_id` 列被移除，便于按住院号关联不同表中的记录。

### v1.16（2025-10-20）

* **修复单个患者导出 Excel 无响应的错误**：修正导出单条记录时程序未能正确保存 Excel 文件的问题，确保选择保存路径后可以正常生成文件。
* **自动刷新各标签页内容**：重新打开程序后，在患者列表双击已有患者时，手术、病理和分子标签页会自动选中并加载第一条历史记录，无需新建条目即可查看已有数据。

### v1.17（2025-10-20）

* **增加刷新按钮**：由于自动刷新存在兼容性问题，每个手术、病理、分子和随访标签页在底部增加了“刷新”按钮。点击该按钮即可重新加载当前患者的相应记录并显示出来，保证新打开程序时能及时查看历史数据。

### v1.18（2025-10-20）

* **新增放疗选项**：在患者/治疗页的“新辅助治疗”添加“放疗”勾选框；在“术后辅助治疗”中删除“术后”两字，改为“辅助治疗”，并在最后增加“放疗”勾选框。
* **内置 TNM 分期映射表**：应用内置简化的肺癌和食管癌 TNM 分期逻辑。输入 TNM 参数后即自动显示临床分期，并在导出的患者表中新增 `lung_stage` 与 `eso_stage` 字段。
* **导出日期统一格式**：导出的 CSV 和 Excel 文件将日期统一格式化为 `yyyymmdd`（例如 20241015）或 `yyyymm`（例如 202407），以消除横杠并补全年份。
* **数据库新增治疗字段**：患者表新增 `nac_radiation` 与 `adj_radiation` 字段存储新辅助和辅助放疗勾选状态。数据库迁移脚本已支持自动添加此字段。
* **病理页 pM 默认值**：病理页的 pM 输入框默认值设为 0，便于快速录入。
* **手术备注框缩窄**：手术标签页的备注输入框宽度减少约三分之一，使界面更紧凑。
* **其它导出改进**：导出时将所有内部计算得到的数值（如手术时长）一并输出，确保录入与导出信息一致。

### v1.19（2025-10-20）

* **AJCC 分期参考**：患者/治疗标签页右侧新增一个 AJCC TNM 分期参考区域。当癌种为肺癌时显示肺癌 TNM 定义，当癌种为食管癌时显示食管癌 TNM 定义，以便快速参考分期标准。
* **手术备注栏位置调整**：手术标签页的备注输入框向右移动，使布局更协调。

### v1.20（2025-10-20）

* **分期参考布局优化**：撤回 v1.19 中在表单底部显示分期内容的方案，在患者/治疗页右侧增加一个与窗口等高的不可编辑文本框。根据所选癌种自动显示肺癌或食管癌的 AJCC TNM 分期定义，缺省为空。此举更好地利用右侧空白区域，便于阅读。
* **保留手术备注栏调整**：继续沿用 v1.19 中对手术标签页备注栏的移动和宽度调整，界面更加协调。

### v1.25（2025-10-22）

* **分期计算按钮完善**：在患者/治疗页的肺癌和食管癌区域，“计算”按钮现在会统一调用新的计算逻辑，先规范化用户输入的 T/N/M 信息（自动补全字母前缀并转换为大写），再调用内置的 TNM → 临床分期映射函数。若输入不完整或映射失败，会在分期栏显示友好提示或弹出错误对话框。
* **自定义 HTML 分期参考视图**：右侧的 AJCC 分期参考区域不再显示原始 Markdown 文本，而改用自定义的 `HTMLScrolledText` 控件来渲染预先转换好的 HTML 格式文档。该控件支持标题字号、粗体、水平线以及简易表格渲染，使分期定义的排版更直观。默认不显示任何内容，用户可通过点击 “Lung” 或 “Eso” 按钮在同一框内切换肺癌或食管癌 TNM 定义。
* **内置分期内容转换**：新增 `tkhtmlview` 模块（自实现的轻量版），用于将嵌入的 AJCC Markdown 定义转换为 HTML 并在界面中显示，无需外部依赖。项目自带的分期 Markdown 文档在加载时即转换为 HTML，以加快渲染速度。
* **版本信息更新**：关于对话框和 README 标题更新为 v1.25，更新历史新增本版本说明。

### v1.26（2025-10-22）

* **移除默认 IV 期兜底**：分期映射函数不再在查表失败时返回统一的 “IV” 期，而是直接返回空值。这样当输入的 TNM 组合在映射表中不存在时，界面会提示“无法映射”而不是误显示为 IV 期。
* **TNM 规范化方式调整**：计算分期时不再添加 “T/N/M” 前缀，而是去除任何前缀并将字母后缀统一转换为小写，从而与映射表中的值（如 “1a”、“2b”、“3”）保持一致。
* **完善食管癌分期参数**：在食管癌分期计算中，映射查询已确保同时传入组织学（SCC/AD）、分级（G1/G2/G3）和部位信息，避免因遗漏条件导致无法匹配。
* **版本号更新**：关于对话框和 README 标题更新为 v1.26，更新历史新增本版本说明。


### v1.11（2025-10-20）

* **新增患者删除功能**：在患者/治疗标签页任意位置点击鼠标右键会弹出“删除当前患者”菜单项。选择该项后系统会弹出两次确认对话框，只有在两次确认均选择“是”后，才会彻底删除该患者记录以及其关联的手术、病理、分子和随访数据。删除操作不可撤销，请谨慎操作。
* **版本号更新**：本 README 标题已更新为 v1.11，以反映此版本的功能改动。

## 许可证

本项目供学习和科研使用，自行承担使用风险。如需在正式项目中使用，请先进行充分测试并遵循相关法规和伦理要求。