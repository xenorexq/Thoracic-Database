# 胸外科科研数据录入系统

本项目是一个基于 Python/Tkinter 的桌面应用程序，旨在在脱机环境中帮助胸外科科研人员录入、管理和导出肺癌/食管癌患者的临床数据。应用使用本地 SQLite 数据库 `thoracic.db` 存储数据，无需任何服务器或网络依赖，支持通过 PyInstaller 打包为单文件可执行程序在 Windows 上运行。

## 功能概述

* 患者信息录入：住院号唯一、癌种（肺癌/食管癌）、性别、出生年月、吸烟史、TNM 分期、食管前置因素、新辅助/术后治疗等。
* 手术记录：可为同一患者录入多次手术，支持肺癌与食管癌不同模板。自动计算手术时长并支持跨日。
* 病理记录：多条/人，包括标本类型、组织学、pTNM、分期、淋巴结信息、TRG 等。
* 分子检测记录：多条/人，支持 PCR/NGS 平台、基因、突变、PD‑L1、TMB/MSI、检测日期等。
* 随访记录：每人 0–1 条，记录最近随访日期、生存状态、复发信息、OS/DFS 等。
* 快速查找：通过住院号或患者 ID 精确定位患者并加载其所有关联记录。
* 自动分期：如果在 `assets/` 目录下提供 AJCC v9 分期映射 CSV，则根据 TNM 和前置条件即时显示分期结果。
* 导出功能：支持导出当前患者或整个数据库为 Excel (`.xlsx`) 或 CSV 多文件，字段完整、含列名。
* 键盘快捷键：Ctrl+S 保存、Ctrl+N 新建、Delete 删除当前记录。

## 项目结构

```
thoracic_entry/
├── assets/            # 图标和可选的 AJCC 分期映射 CSV（map_lung_v9.csv 等）
├── db/
│   └── models.py      # SQLite 数据库定义及数据访问对象
├── export/
│   ├── excel.py       # Excel 导出实现（依赖 openpyxl）
│   └── csv.py         # CSV 导出实现
├── staging/
│   └── lookup.py      # 分期映射加载及查询函数
├── ui/
│   ├── patient_tab.py # 患者/治疗 Tab
│   ├── surgery_tab.py # 手术 Tab
│   ├── path_tab.py    # 病理 Tab
│   ├── mol_tab.py     # 分子 Tab
│   ├── fu_tab.py      # 随访 Tab
│   └── export_tab.py  # 查询/导出 Tab
├── utils/
│   └── validators.py  # 输入校验和格式化函数
├── main.py            # 应用入口
├── requirements.txt   # 依赖列表（openpyxl）
└── README.md          # 使用说明
```

## 安装与运行

1. 确保安装 Python 3.10+ 环境。若需打包请安装 `pyinstaller`：

   ```bash
   pip install -r requirements.txt
   pip install pyinstaller
   ```

2. （可选）将 AJCC v9 分期映射 CSV 放入 `assets/` 目录下，文件名需为 `map_lung_v9.csv`、`map_eso_v9_scc.csv`、`map_eso_v9_ad.csv`。首次启动程序会自动读取并填充映射表。

3. 运行应用：

   ```bash
   python -m thoracic_entry.main
   ```

   首次运行时会在当前目录下生成 `thoracic.db` 数据库文件并自动建表。

4. 打包 Windows 可执行文件：

   ```bash
   pyinstaller --noconfirm --clean --onefile --name thoracic_entry --icon=assets/app.ico thoracic_entry/main.py
   ```

   打包完成后，在 `dist/` 目录下生成 `thoracic_entry.exe`。该可执行文件可在无 Python 环境的 Windows 系统上直接运行，不需要管理员权限。

## 使用说明

1. **新建患者**：在“患者/治疗”页填写住院号、癌种、性别等必填项（带 * 号）。填完点击“保存”或按 `Ctrl+S` 保存。住院号必须唯一，重复会提示错误。
2. **录入手术/病理/分子/随访**：保存患者后切换到相应 Tab 进行录入。列表中显示已有记录，点击可编辑；点击“新建”清空表单；点击“删除”移除当前记录。
3. **快速查找**：在窗口顶部输入住院号或患者 ID 后点击“查找”，程序会加载对应患者及其所有关联记录。
4. **导出**：在“查询/导出”页可以导出当前患者或全库数据。选择导出为 Excel 时需指定 `.xlsx` 文件保存路径；导出为 CSV 时需选择输出目录，程序会生成多个 CSV 文件。
5. **自动分期**：若提供了分期映射表，选择 TNM 及食管前置后分期文本会自动刷新。若映射表为空或找不到匹配项，分期处留空。
6. **数据校验**：
   * 出生年月（yymm）、手术日期（yymmdd）、报告/检测日期等必须为纯数字并符合格式要求。
   * 时间（hhmm）必须 0000–2359，分钟小于 60；程序会自动计算跨日时长。
   * 必填项未填或格式错误将阻止保存并提示错误信息。

## 常见问题与排查

* **无法启动或提示缺少模块**：请确认已安装依赖 `openpyxl` 和 `pyinstaller`，并使用正确版本的 Python。
* **无法写入数据库或导出文件**：检查程序所在目录或目标目录是否具有写权限，避免路径包含中文或特殊字符。
* **杀毒软件误报**：由于本程序使用 PyInstaller 打包，部分杀毒软件可能误报。请添加信任或排除。

## 示例测试数据

运行程序后可按以下步骤测试基本功能：

1. 在患者页点击“新建”，输入：
   * 住院号：`H123456`
   * 癌种：`肺癌`
   * 性别：`男`
   * 出生年月：`9007`
   * 吸烟包·年：`20.5`
   * 多源发星标：勾选
   * 肺 TNM：`T1b`, `N0`, `M0`
   点击保存。
2. 切换到手术页，点击“新建”，输入：
   * 手术日期：`241015`
   * 开始：`0830`
   * 结束：`1115`
   * 其他字段可留默认，点击保存。检查时长显示为 `165` 分钟。
3. 再次新建，测试跨日手术：开始 `2305`，结束 `0040`，保存后时长为 `95` 分钟。
4. 切换到随访页输入随访日期、状态等，保存。
5. 在导出页导出当前患者为 Excel 和 CSV，检查生成文件内容完整。

双击build_simple.bat build_exe.bat 或者build_exe.bat打包程序
打包好的程序在dist目录内
所有代码均由ChatGPT和Manus1.5输出
## 许可证

本项目供学习和科研使用，自行承担使用风险。如需在正式项目中使用，请先进行充分测试并遵循相关法规和伦理要求。
