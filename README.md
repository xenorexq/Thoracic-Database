# 胸外科科研数据录入系统

**当前版本:** v3.5.4
**发布日期:** 2025年11月23日  


---

## 📋 目录

- [项目简介](#项目简介)
- [核心功能](#核心功能)
- [项目结构](#项目结构)
- [安装与运行](#安装与运行)
- [使用指南](#使用指南)
- [版本历史](#版本历史)
- [技术说明](#技术说明)
- [常见问题](#常见问题)
- [许可证](#许可证)

---

## 项目简介

本项目是一个基于 **Python/Tkinter** 的桌面应用程序，专为胸外科科研人员设计，用于在脱机环境中录入、管理和导出肺癌/食管癌患者的临床数据。

### 主要特点

- **本地化存储:** 使用 SQLite 数据库（`thoracic.db`），无需服务器或网络依赖
- **跨平台支持:** 支持 Windows/Linux/macOS，可打包为单文件可执行程序
- **数据完整性:** 支持患者、手术、病理、分子检测、随访等全流程数据管理
- **安全可靠:** v2.0+ 版本修复了SQL注入漏洞，增强了异常处理机制
- **易于导出:** 支持导出为 Excel (.xlsx) 或 CSV 格式，字段完整

---

## 核心功能

### 1. 患者信息管理
- **基本信息:** 住院号（唯一）、癌种（肺癌/食管癌）、性别、出生年月
- **临床信息:** 吸烟史、TNM 分期、食管前置因素
- **治疗信息:** 新辅助治疗（化疗/免疫/靶向/放疗）、辅助治疗（化疗/免疫/靶向/放疗）
  - **治疗日期（v2.12新增）:** 新辅助和辅助治疗均可记录治疗日期（yymmdd格式）
- **特殊标记:** 多源发、家族恶性肿瘤史

### 2. 手术记录
- **多次手术支持:** 同一患者可录入多次手术
- **肺癌手术细节:** 
  - 手术方式（胸腔镜/开胸/机器人）
  - 切除范围（楔形/肺段/肺叶/复合肺叶/全肺）
  - 肺叶位置（上叶/中叶/下叶/多发）
  - **侧别标记（v2.01新增）:** 左侧/右侧/双侧
  - 病灶数、主病灶尺寸
- **食管癌手术细节:** 部位（食管/贲门）
- **通用信息:** 手术日期、适应症、开始/结束时间（自动计算时长，支持跨日）、淋巴清扫、R0切除
- **备注:** 手术备注信息

### 3. 病理记录
- **多条记录支持:** 每位患者可有多条病理记录
- **病理信息:** 
  - 标本类型、组织学类型、分化程度
  - pTNM分期（pT/pN/pM）、临床分期
  - 脉管侵犯（LVI）、神经侵犯（PNI）、胸膜侵犯
  - 气道播散、病理号
  - 肺腺癌主要亚型（贴壁型/腺泡型等）
  - 淋巴结信息、肿瘤退缩分级（TRG）
  - 报告日期、备注

### 4. 分子检测记录
- **多条记录支持:** 每位患者可有多条分子检测记录
- **检测信息:**
  - 检测平台（PCR/NGS）
  - 检测基因列表、结果摘要
  - 基因突变信息（基因名、变异类型）
  - PD-L1表达百分比
  - TMB/MSI状态
  - 循环肿瘤细胞计数（CTC）
  - 甲基化检测结果
  - 检测日期、备注

### 5. 随访记录（v2.1重构）
- **事件驱动系统:** 每次随访互动作为独立的、带时间戳的事件记录
- **事件类型:**
  - 生存：记录患者存活状态
  - 复发/转移：记录复发或转移事件（需指定部位）
  - 进展：记录疾病进展（需指定部位）
  - 死亡：记录患者死亡
  - 失访：记录失去联系
- **事件信息:**
  - 事件日期（YYYYMMDD格式）
  - 事件类型
  - 事件详情（部位、备注等）
- **界面设计:**
  - 上部：事件日志显示区（按时间倒序）
  - 下部：快速录入面板（保存后自动清空）

### 6. 查询与导出
- **快速查找:** 通过住院号或患者ID精确定位患者
- **导出选项:**
  - 导出当前患者或整个数据库
  - 支持 Excel (.xlsx) 单文件导出
  - 支持 CSV 多文件导出（每个表一个文件）
  - 所有UI输入字段完整导出，包括：
    - v2.01新增的左右侧别字段
    - v2.12新增的新辅助/辅助治疗日期字段
  - **导出表结构（v2.12优化）:**
    - Patient：患者基本信息和治疗信息
    - Surgery：手术记录
    - Pathology：病理记录
    - Molecular：分子检测记录
    - FollowUpEvent：随访事件记录（事件驱动系统）

### 7. AJCC 分期参考
- **内置参考:** 右侧显示 AJCC TNM 分期定义
- **手动切换:** 点击"Lung"或"Eso"按钮查看肺癌或食管癌分期标准
- **可调宽度:** 拖动分隔条调整参考栏宽度

### 8. 键盘快捷键
- **Ctrl+S:** 保存当前记录
- **Ctrl+N:** 新建记录
- **Delete:** 删除当前记录

### 9. 数据库导入

从 v3.1 版本开始，程序支持直接从其他 SQLite 数据库批量合并患者数据。导入逻辑仅以患者表 (`Patient`) 的 **住院号** 作为唯一标识：

- 通过菜单栏中的 **文件 → 导入数据库...** 可以一次性选择多个 `.db` 文件。
- 只有当源库中的住院号在当前数据库不存在时，才会导入该患者及其所有关联的手术、病理、分子检测和随访记录。
- 如果住院号已经存在于当前数据库，则跳过该患者及其所有关联记录，以保护当前库中经过编辑或补充的数据。
- 导入完成后会弹出统计对话框，显示新增患者和各表新增记录的数量。

---

## 项目结构

```
thoracic_entry/
├── assets/                 # 图标资源
├── db/
│   ├── models.py          # 数据库模型和数据访问层
│   └── migrate.py         # 数据库迁移脚本（v2.0+）
├── export/
│   ├── excel.py           # Excel 导出（openpyxl）
│   └── csv.py             # CSV 导出
├── staging/
│   └── lookup.py          # 分期映射查询（已弃用）
├── ui/
│   ├── patient_tab.py     # 患者/治疗标签页
│   ├── surgery_tab.py     # 手术标签页
│   ├── path_tab.py        # 病理标签页
│   ├── mol_tab.py         # 分子检测标签页
│   ├── fu_tab.py          # 随访标签页
│   └── export_tab.py      # 查询/导出标签页
├── utils/
│   └── validators.py      # 输入校验和格式化
├── main.py                # 应用入口
├── requirements.txt       # Python依赖
├── README.md              # 本文档
├── CHANGELOG_v2.0.md      # v2.0更新日志
├── CHANGELOG_v2.01.md     # v2.01更新日志
└── VERSION.txt            # 版本信息
```

---

## 安装与运行

### 系统要求
- **Python:** 3.10 或更高版本
- **操作系统:** Windows / Linux / macOS
- **依赖库:** openpyxl（Excel导出）

### 安装步骤

#### 1. 克隆或下载项目
```bash
git clone https://github.com/xenorexq/Thoracic-Database.git
cd Thoracic-Database
```

或直接下载并解压 `Thoracic-Database-v2.01.zip`

#### 2. 安装依赖
```bash
pip install -r requirements.txt
```

如需打包为可执行文件：
```bash
pip install pyinstaller
```

#### 3. 运行程序
```bash
python main.py
```

首次运行时会在当前目录下自动创建 `thoracic.db` 数据库文件。

### 打包为可执行文件

#### Windows 单文件可执行程序
```bash
pyinstaller --noconfirm --clean --onefile \
  --name thoracic_entry \
  --icon=assets/app.ico \
  main.py
```

打包完成后，在 `dist/` 目录下生成 `thoracic_entry.exe`，可在无 Python 环境的 Windows 系统上直接运行。

---

## 使用指南

### 基本工作流程

#### 1. 新建患者
1. 打开程序，进入"患者/治疗"标签页
2. 点击"新建"按钮清空表单
3. 填写必填项（带 * 号）：
   - 住院号（必须唯一）
   - 癌种（肺癌/食管癌）
   - 性别
4. 填写其他信息（出生年月、吸烟史、TNM分期等）
5. 点击"保存"或按 `Ctrl+S` 保存

#### 2. 录入手术记录
1. 保存患者后，切换到"手术"标签页
2. 点击"新建"按钮
3. 填写手术信息：
   - 手术日期（yymmdd格式，如 241015）
   - 开始/结束时间（hhmm格式，如 0830、1145）
   - 手术方式、切除范围、肺叶位置
   - **v2.01新增:** 勾选左侧/右侧/双侧
4. 点击"保存"

**示例：**
```
日期: 241015
开始: 0830
结束: 1145
→ 自动计算时长: 195分钟

肺叶: 上叶
[☑左] [☐右] [☐双侧]  ← v2.01新增
```

#### 3. 录入病理记录
1. 切换到"病理"标签页
2. 点击"新建"
3. 填写病理信息（标本类型、组织学、pTNM等）
4. 点击"保存"

#### 4. 录入分子检测记录
1. 切换到"分子"标签页
2. 点击"新建"
3. 填写检测信息（平台、基因、突变、PD-L1等）
4. 点击"保存"

#### 5. 录入随访记录
1. 切换到"随访"标签页
2. 填写随访信息（随访日期、生存状态、复发信息等）
3. 点击"保存"

#### 6. 查询患者
1. 在窗口顶部输入框输入住院号或患者ID
2. 点击"查找"按钮
3. 程序自动加载该患者及其所有关联记录

#### 7. 导出数据
1. 切换到"查询/导出"标签页
2. 选择导出范围：
   - 当前患者
   - 整个数据库
3. 选择导出格式：
   - Excel (.xlsx) - 单文件，包含多个工作表
   - CSV - 多个文件，每个表一个文件
4. 选择保存路径并确认

### 数据校验规则

- **出生年月（yymm）:** 4位数字，月份01-12
- **手术日期（yymmdd）:** 6位数字，月份01-12，日期01-31
- **时间（hhmm）:** 4位数字，小时00-23，分钟00-59
- **住院号:** 必须唯一，不能重复
- **必填项:** 未填或格式错误将阻止保存并提示错误

### 删除操作

#### 删除患者
1. 在"患者/治疗"标签页任意位置点击鼠标右键
2. 选择"删除当前患者"
3. 两次确认后删除（包括所有关联的手术、病理、分子、随访记录）
4. **注意:** 删除操作不可撤销

#### 删除其他记录
1. 在相应标签页选中要删除的记录
2. 点击"删除"按钮
3. 确认后删除

---

## 版本历史
### v3.5.4 (2025-11-23)

- **UI/UX 升级**：
  - 全面引入 **ttkbootstrap** 现代化主题（默认 cosmo 主题），界面更扁平、美观，交互反馈更清晰。
  - 增加了导入/导出操作的**进度条**显示。

- **性能优化**：
  - **数据库导入重构**：采用多线程 + 事务批量提交机制。现在导入上万条记录的数据文件时，界面不再卡死，且速度提升显著（实测 100 倍以上提升）。

### v3.5.3 (2025-11-23)

- **Bug 修复**：
  - **数据回显优化**：修复了部分字段（如治疗周期、日期等）如果为空时，再次加载会在输入框中显示为 "None" 字符串的问题。现在空值将正确显示为空白，避免了保存时因 "None" 不符合日期格式而导致的校验错误。
  - **UI 交互优化**：移除了随访事件的随机编号显示，界面更简洁；列表增加了动态序号列；导入操作现在支持多线程和进度条，提升了大数据量下的响应速度。

### v3.5.2 (2025-11-23)

- **兼容性修复**：
  - **旧版随访数据导入**：修复了从 v2.0 及更早版本数据库导入数据时随访信息丢失的问题。现在，如果源数据库中不存在新的 `FollowUpEvent` 表，程序会自动检测并从旧的 `FollowUp` 表中提取末次随访日期、生存状态和死亡日期，将其转换为新的随访事件记录导入，确保历史数据不丢失。

### v3.5.1 (2025-11-23)

- **Bug 修复**：
  - **多 Tab 状态同步**：修复在保存患者信息后，其他标签页（如手术、病理）的状态（特别是 `current_hospital_id`）未及时更新，导致后续新增记录时可能出现界面显示异常的问题。现在保存患者后会触发全局重载，确保所有 Tab 状态同步。
  - **数据库导入增强**：
    - **单条容错**：在导入过程中，将异常捕获粒度细化到单条记录，防止因某条记录的数据问题导致整个表的后续导入中断。
    - **随访编码冲突解决**：在导入随访事件 (`FollowUpEvent`) 时，不再使用源数据库的 `event_code`，而是让目标数据库自动生成新的唯一编码，彻底规避因编码重复导致的唯一性约束冲突（Potential Conflict）。

### v3.5 (2025-11-23)

- **全局状态管理重构**：新增 `current_patient_id` 和 `current_hospital_id` 变量，各标签页通过全局状态定位当前患者，不再各自维护独立状态。
- **列表结构统一**：手术、病理、分子检测、随访列表统一为“住院号 + 日期”前两列，彻底移除旧的“编号/seq”列，展示信息更直观。
- **标准 CRUD 实现**：各标签页实现标准的新增/修改/删除逻辑，引入 `current_record_id` 用于主键定位，确保保存操作真正写入数据库，并在操作后自动刷新界面。
- **数据库导入优化**：合并多个 `.db` 文件时仅以 `hospital_id` 判断患者唯一性，不再参考编号字段；若住院号已存在，则跳过该患者的所有子表记录，避免产生重复或冲突。
- **Bug 修复与界面优化**：解决手术、病理、分子页保存无反应、随访事件无法录入等问题，界面显示更一致，逻辑更稳定。
- **版本号更新**：更新 `VERSION.txt` 为 `v3.5`，并同步修改“关于”对话框和 README 中的版本号。

### v3.3 (2025-11-22)

- **Bug修复与增强**
  - **患者保存逻辑统一:** 修复在保存已有患者信息时可能错误地走入新建分支导致数据未更新的问题。保存时统一根据当前患者 ID 或住院号判断记录是否存在，存在则更新，不存在则新建，并在保存后重新从数据库加载记录，确保界面数据与数据库完全同步。
  - **再次加载更新数据:** 保存后自动重新加载患者信息，避免在刷新列表后界面仍显示旧数据的情况。
  - **右键菜单兼容 macOS:** 保持 v3.2 中对 Button‑2 和 Ctrl+左键的绑定，以支持 macOS 双指触控板及 Ctrl+左键调出删除菜单。
  - **版本号更新:** 更新 `VERSION.txt` 为 `v3.3`，并同步修改“关于”对话框和 README 中的版本号。

### v3.2 (2025-11-22)

- **Bug修复与增强**
  - **编辑患者信息:** 修复在切换患者后再编辑并保存时数据无法更新的问题。现在在保存患者信息时，当住院号已存在且 `current_patient_id` 为 `None` 时，自动切换为更新模式而不是插入新记录，确保修改能正确写入。
  - **右键菜单兼容 macOS:** 绑定 Button‑2 和 Ctrl+左键事件，支持 macOS 触控板及 Ctrl+左键调用删除菜单。
- **版本号更新**
  - 更新 `VERSION.txt` 为 `v3.2`，并同步修改“关于”对话框和 README 中的版本号。

### v3.1 (2025-11-19)

- **功能增强**
  - **数据库导入功能:** 允许在“文件→导入数据库...”对话框中一次性选择多个 `.db` 文件进行导入。导入逻辑以患者表 (`Patient`) 的 `hospital_id` 作为唯一标识，只将新住院号的患者及其所有手术、病理、分子检测和随访记录追加到当前数据库中，已存在的住院号将被跳过，以保护主库中已编辑的数据。
  - **导入统计:** 导入完成后显示新增患者数量以及各表（手术、病理、分子、随访）的新增记录数。
- **版本号更新**
  - 更新 `VERSION.txt` 为 `v3.1`，并同步修改“关于”对话框中的版本号。

### v3.0 (2025-10-24)

- **功能优化**
  - **随访标签页:** 移除“编号”输入框及“随机编号”按钮，事件编号改为后台自动生成并在界面中隐藏。
  - **数据导出:** 随访事件的内部编号 (`event_code`) 不再包含在导出的 Excel/CSV 文件中，导出的数据更为简洁。
  - **新建患者:** 点击“新建患者”按钮时，系统将刷新并清空所有标签页的列表与表单，方便录入新的患者信息。

- **版本号更新**
  - 更新 `VERSION.txt` 为 `v3.0`，并同步修改“关于”对话框中的版本号。


### v2.16 (2025-10-23)

- **Bug修复**
  - **sqlite3.Row.get()错误**: 修复保存手术、病理、分子记录后出现"sqlite3.Row object has no attribute get"错误
  - **原因**: surgery_tab.py, path_tab.py, mol_tab.py的load_patient()方法中，sorted()直接对sqlite3.Row使用.get()方法
  - **解决**: 在sorted()的lambda表达式中使用dict(x).get()进行转换
  - **随访保存错误**: 修复随访标签页点击保存时错误提示"请先选择或创建患者"
  - **原因**: fu_tab.py的save_record()方法中，未从app.current_patient_id获取当前患者ID
  - **解决**: 在检查self.current_patient_id前，先尝试从self.app.current_patient_id获取

### v2.15 (2025-10-23)

- **Bug修复**
  - **sqlite3.Row错误**: 修复保存手术、病理、分子记录时出现"sqlite3.Row object has no attribute get"错误
  - **原因**: export/excel.py中使用row.get()但未将sqlite3.Row转换为dict
  - **解决**: 在使用row.get()前添加row_dict = dict(row)转换
  - **随访页面切换**: 完全重建随访标签页，参考surgery_tab.py的实现方式
  - **原因**: 原随访页面的load_patient()方法未正确实现
  - **解决**: 重写fu_tab.py，采用与其他标签页一致的架构

### v2.14 (2025-10-23)

- **Bug修复**
  - **递归错误**: 修复新建患者保存后出现"Maximum recursion depth exceeded"错误
  - **原因**: v2.13在`refresh_patient_list()`中自动调用`load_patient()`导致递归
  - **解决**: 添加`reload_data`参数，默认为False，避免不必要的数据重载

### v2.13 (2025-10-23)

- **功能增强**
  - **病理标签页**: 肺腺癌主要亚型下移一行，病理号后增加日期输入（yymmdd格式）
  - **随访标签页**: 增加右键删除功能
  - **患者/治疗标签页**: 新辅助/辅助治疗增加"抗血管"治疗选项

- **UI优化**
  - **条目框**: 删除手术ID、病理ID、Mol ID、随访ID列
  - **条目框**: 所有条目框最左侧显示日期，并按日期由近到远排序

- **Bug修复**
  - **随访标签页**: 修复切换患者时随访条目不更新的Bug
  - **随访标签页**: 修复新增随访事件编码错误的Bug

### v2.01（2025-10-22）

#### 新增功能
- **手术侧别记录:** 在手术标签页肺叶下拉栏后新增"左"和"右"打勾框
- **数据库字段:** Surgery表新增 `left_side` 和 `right_side` 字段
- **导出验证:** 确认所有UI字段（包括新增字段）正确导出到Excel和CSV

#### 技术改进
- 补充Patient、Pathology、Molecular表的缺失字段
- 更新数据库迁移脚本，支持自动添加新字段
- 完整导出测试：12/12通过（100%）

#### 升级指南
从v2.0升级：
1. 备份数据库文件
2. 替换程序文件
3. 运行 `python db/migrate.py`
4. 启动程序

---

### v2.0（2025-10-22）

#### 安全性修复 🔒
- **SQL注入防护:** 在 `export_table()` 方法中添加表名白名单验证
- **防御措施:** 仅允许预定义的合法表名（Patient, Surgery, Pathology, Molecular, FollowUp）

#### 稳定性提升 🛡️
- **UI异常处理:** 修复3个空的except块，添加错误日志
  - `ui/mol_tab.py`
  - `ui/path_tab.py`
  - `ui/surgery_tab.py`
- **导出异常处理:** 为Excel和CSV导出添加完整的异常处理
  - 自动创建目标目录
  - 区分权限错误和一般错误
  - 提供友好的中文错误提示

#### 代码清理 📝
- 删除所有测试文件和临时数据
- 移除 `.git` 目录，减小分发包体积
- 清理所有 `__pycache__` 缓存

#### 性能测试结果 ⚡
| 测试项 | 操作数量 | 速率 (ops/s) |
| :--- | ---: | ---: |
| 批量插入患者 | 1000 | 2869.3 |
| 批量查询患者 | 1000 | 75491.4 |
| 混合并发操作 | 300 | 4753.8 |
| 大结果集查询 | 1000 | 237705.0 |
| 级联删除 | 50 | 2382.5 |

#### 崩溃测试结果 ✅
- SQL注入防护: 8/8 通过
- 无效表名防护: 5/5 通过
- Unicode支持: 8/8 通过
- 外键约束: 1/1 通过
- 数据库损坏检测: 1/1 通过

---

### v1.31及更早版本（2025-10-20）

#### v1.30
- 移除 TNM 分期自动计算功能
- AJCC 分期参考区域添加可调节宽度的分隔条

#### v1.26
- 移除默认 IV 期兜底逻辑
- 调整 TNM 规范化方式

#### v1.25
- 完善分期计算按钮
- 自定义 HTML 分期参考视图

#### v1.20
- 分期参考布局优化
- 右侧添加等高文本框显示 AJCC 定义

#### v1.19
- 新增 AJCC 分期参考区域
- 手术备注栏位置调整

#### v1.18
- 新增放疗选项（新辅助和辅助）
- 内置 TNM 分期映射表
- 导出日期统一格式
- 病理页 pM 默认值设为 0

#### v1.17
- 各标签页增加"刷新"按钮

#### v1.16
- 修复单个患者导出 Excel 无响应
- 自动刷新各标签页内容

#### v1.15
- 导出数据使用住院号识别患者

#### v1.14
- 精简导出字段，移除废弃字段

#### v1.13
- 分子列表新增平台列
- 病理列表调整列显示

#### v1.12
- 手术方式顺序调整（胸腔镜移至第一位）
- 修复病理记录保存问题

#### v1.11
- 新增患者删除功能（右键菜单）

---

## 技术说明

### 数据库架构

#### Patient 表
主要字段：
- `patient_id` (主键)
- `hospital_id` (唯一，住院号)
- `cancer_type` (癌种)
- `sex`, `birth_ym4` (性别、出生年月)
- `pack_years` (吸烟包·年)
- `lung_t`, `lung_n`, `lung_m` (肺癌TNM)
- `eso_t`, `eso_n`, `eso_m` (食管癌TNM)
- `eso_from_incisors_cm` (距门齿距离)
- `family_history` (家族史)
- `nac_*`, `adj_*` (新辅助和辅助治疗)

#### Surgery 表
主要字段：
- `surgery_id` (主键)
- `patient_id` (外键)
- `surgery_date6`, `indication` (日期、适应症)
- `start_hhmm`, `end_hhmm`, `duration_min` (时间)
- `approach`, `scope_lung`, `lobe` (手术方式、范围、肺叶)
- `left_side`, `right_side` (v2.01新增：侧别)
- `bilateral` (双侧)
- `lesion_count`, `main_lesion_size_cm` (病灶信息)

#### Pathology 表
主要字段：
- `path_id` (主键)
- `patient_id` (外键)
- `specimen_type`, `histology` (标本、组织学)
- `pt`, `pn`, `pm` (pTNM)
- `pleural_invasion`, `airway_spread` (侵犯信息)
- `pathology_no` (病理号)
- `aden_subtype` (腺癌亚型)

#### Molecular 表
主要字段：
- `mol_id` (主键)
- `patient_id` (外键)
- `platform`, `genes_tested`, `result_summary` (检测信息)
- `pdl1_percent`, `tmb_msi` (生物标志物)
- `ctc_count`, `methylation_result` (CTC、甲基化)

#### FollowUp 表
主要字段：
- `patient_id` (主键，一对一)
- `last_visit_date`, `status` (随访日期、状态)
- `death_date` (死亡日期)
- `relapse`, `relapse_date`, `relapse_site` (复发信息)

### 数据迁移

v2.0+ 版本包含数据库迁移脚本 `db/migrate.py`，可自动检测并添加缺失字段：

```bash
python db/migrate.py
```

迁移脚本会：
1. 检查现有数据库架构
2. 添加缺失的字段
3. 设置默认值
4. 保持现有数据完整性

### 安全特性（v2.0+）

#### SQL注入防护
```python
# 白名单验证表名
allowed_tables = ['Patient', 'Surgery', 'Pathology', 'Molecular', 'FollowUp']
if table_name not in allowed_tables:
    raise ValueError(f"Invalid table name: {table_name}")
```

#### 异常处理
```python
# 导出功能异常处理示例
try:
    file_path.parent.mkdir(parents=True, exist_ok=True)
    wb.save(file_path)
except PermissionError as e:
    raise PermissionError(f"无法写入文件 {file_path}，请检查文件权限") from e
except Exception as e:
    raise Exception(f"导出失败: {str(e)}") from e
```

---

## 常见问题

### Q1: 无法启动或提示缺少模块
**A:** 确认已安装依赖：
```bash
pip install -r requirements.txt
```

### Q2: 无法写入数据库或导出文件
**A:** 检查以下几点：
- 程序所在目录是否有写权限
- 目标目录是否存在且可写
- 避免路径包含中文或特殊字符
- 确保数据库文件未被其他程序占用

### Q3: 杀毒软件误报
**A:** PyInstaller 打包的程序可能被部分杀毒软件误报。解决方法：
- 添加程序到信任列表
- 添加排除规则
- 使用官方发布的版本

### Q4: 如何从旧版本升级？
**A:** 升级步骤：
1. **备份数据库文件** `thoracic.db`
2. 下载新版本程序
3. 替换程序文件（保留数据库）
4. 运行迁移脚本：`python db/migrate.py`
5. 启动程序验证

### Q5: 导出的Excel或CSV文件缺少字段？
**A:** v2.01版本已通过完整测试，确保所有UI输入字段都能正确导出。如果仍有问题：
- 确认使用的是v2.01或更高版本
- 检查是否运行了数据库迁移脚本
- 尝试重新保存记录后再导出

### Q6: 手术时长计算错误？
**A:** 程序支持跨日计算。示例：
- 开始 23:05，结束 00:40 → 95分钟 ✓
- 开始 08:30，结束 11:45 → 195分钟 ✓

确保时间格式正确（hhmm，如 0830）。

### Q7: 如何删除患者？
**A:** 
1. 在"患者/治疗"标签页任意位置点击鼠标右键
2. 选择"删除当前患者"
3. 两次确认后删除
4. **注意:** 会同时删除该患者的所有关联记录（手术、病理、分子、随访）

### Q8: AJCC分期参考如何使用？
**A:** 
- 右侧文本框显示 AJCC TNM 分期定义
- 点击"Lung"按钮查看肺癌分期
- 点击"Eso"按钮查看食管癌分期
- 拖动分隔条调整宽度
- 仅供参考，不自动计算分期

---

## 测试与质量保证

### v2.01 测试结果

#### 完整导出测试
```
测试项目: v2.01完整导出测试
通过: 12/12 (100%)
问题: 0

验证字段:
✓ Surgery.left_side (Excel & CSV)
✓ Surgery.right_side (Excel & CSV)
✓ Surgery.lobe (Excel & CSV)
✓ Surgery.bilateral (Excel & CSV)
✓ Surgery.approach (Excel & CSV)
✓ Surgery.scope_lung (Excel & CSV)
```

#### 数据迁移测试
```
测试场景: 从v2.0数据库升级
迁移结果: ✓ 成功
新增字段: 6个
数据完整性: ✓ 保持
功能兼容性: ✓ 完全兼容
```

### v2.0 测试结果

#### 压力测试
- 批量插入：2869 ops/秒
- 批量查询：75491 ops/秒
- 混合操作：4753 ops/秒
- 级联删除：2382 ops/秒

#### 安全测试
- SQL注入防护：8/8 通过
- 无效表名防护：5/5 通过
- Unicode支持：8/8 通过

---

## 开发与贡献

### 技术栈
- **语言:** Python 3.10+
- **GUI框架:** Tkinter
- **数据库:** SQLite 3
- **Excel处理:** openpyxl
- **打包工具:** PyInstaller

### 项目文件说明
- `main.py` - 应用程序入口
- `db/models.py` - 数据库模型和ORM
- `db/migrate.py` - 数据库迁移脚本
- `ui/*.py` - 各标签页UI实现
- `export/*.py` - 导出功能实现
- `utils/validators.py` - 数据验证工具

### 代码规范
- 遵循 PEP 8 编码规范
- 使用类型提示（Type Hints）
- 完善的异常处理
- 中文注释和文档字符串

---

## 许可证

本项目供学习和科研使用，使用者自行承担使用风险。

### 使用条款
- ✅ 允许用于学术研究和科研工作
- ✅ 允许修改和二次开发
- ⚠️ 正式项目使用前请充分测试
- ⚠️ 遵循相关法规和伦理要求
- ❌ 不提供任何明示或暗示的担保

### 数据安全
- 本地存储，无网络传输
- 用户自行负责数据备份
- 建议定期备份 `thoracic.db` 文件

---

## 联系与支持

### 问题反馈
- **GitHub Issues:** [创建Issue](https://github.com/xenorexq/Thoracic-Database/issues)
- **邮件:** （如有）

### 反馈时请提供
1. 版本号（v2.01）
2. 操作系统和Python版本
3. 详细的问题描述
4. 操作步骤和错误信息
5. 相关截图（如有）

---

## 致谢


感谢@licctvcctv 对3.0版本的修改支持

---

**版本:** v3.0  
**最后更新:** 2025年10月24日  


**本项目所有代码均由ChatGPT和Manus完成。**

